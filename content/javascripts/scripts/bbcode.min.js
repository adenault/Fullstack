!function(e){var UPLOAD_LOC="/content/uploads/";e.fn.BBCode=function(options){var that=$(this),that_class=that.attr("class"),that_id=that.attr("id"),content=that.html(),encodeContent=content,decodeContent=decodeHtmlEntity(content),parent=that.parent(),divSelection={start:0,end:0,text:"",thatid:""},rowCount=0,default_url="/content/tpl/bbcode";$.get(default_url+"/template.tpl",(function(data){that.remove(),parent.append(data),$(".bb-source").attr("id",that_id),$("#"+that_id).html(encodeContent),$("#"+that_id).attr("class",that_class),divSelection=getSelectionRange()}));var settings=$.extend({alignment:!0,style:!0,fontsize:!0,fontfamily:!0,fontcolor:!0,images:!1,files:!1,link:!1,table:!1,videos:!1,scripts:!0,list:!0,strike:!0,symbols:!1},options);function makeList(container,style,row){var type,list=$("<"+("bullet"==style?"u":"o")+"l/>").addClass("insertUl").attr("id","bbcode_list").attr("data-style",style).css({"list-style-type":style});for(r=0;r<row;r++)list.append($("<li><textarea></textarea></li>"));return container.append(list)}function makeTable(container,row,column){var table=$("<table/>").addClass("insertTable").attr("id","bbcode_table").attr("data-rows",row);for(r=0;r<row;r++){var rowdata=$("<tr/>");for(c=0;c<column;c++)rowdata.append($("<td><textarea></textarea></td>"));table.append(rowdata)}return container.append(table)}function ytVidId(url){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return!!url.match(p)&&RegExp.$1}function focusOn(){if(0==divSelection.thatid.length){$("#"+that_id).focus();var data=$("#"+that_id).val();$("#"+that_id).focus().val("").val(data),divSelection=getSelectionRange()}}function validateURL(textval){var urlregex;return new RegExp("^(http|https|ftp)://([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&amp;%$-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9-]+.)*[a-zA-Z0-9-]+.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(:[0-9]+)*(/($|[a-zA-Z0-9.,?'\\+&amp;%$#=~_-]+))*$").test(textval)}function wrapBBCode(item,option=null,inner=null,isChecked=!1){var ins="["+item+"]"+divSelection.text+"[/"+item+"]";if("link"==item||"url"==item?ins="["+item+"="+option+(!0===isChecked?" option=new_page":"")+"]"+(inner.length>0?inner:option)+"[/"+item+"]":null!==inner?ins="["+item+"="+option+"]"+inner+"[/"+item+"]":null!=option&&(ins="image"===item||"youtube"==item?"["+item+"]"+option+"[/"+item+"]":"["+item+"="+option+"]"+divSelection.text+"[/"+item+"]"),focusOn(),window.getSelection)divSelection.thatid.value=divSelection.thatid.value.substring(0,divSelection.start)+ins+divSelection.thatid.value.substring(divSelection.end,divSelection.thatid.value.length),divSelection.thatid.setSelectionRange(divSelection.end+ins.length,divSelection.end+ins.length-divSelection.text.length);else if(document.selection){var selectedRange=document.selection.createRange();selectedRange.moveStart("character",-divSelection.thatid.value.length),sel.text=ins,sel.moveStart("character",selectedRange.text.length+ins.length-divSelection.thatid.length)}divSelection=getSelectionRange()}function insertBBCode(item,option){var ins="&"+option+";";if(focusOn(),window.getSelection)divSelection.thatid.value=divSelection.thatid.value.substring(0,divSelection.start)+ins+divSelection.thatid.value.substring(divSelection.start,divSelection.thatid.value.length),divSelection.thatid.setSelectionRange(divSelection.end+ins.length,divSelection.end+ins.length);else if(document.selection){var selectedRange=document.selection.createRange();selectedRange.moveStart("character",-divSelection.thatid.value.length),sel.text=ins,sel.moveStart("character",selectedRange.text.length+ins.length-divSelection.thatid.length)}divSelection=getSelectionRange()}function trimcode(str){return str.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function getSelectionRange(){var sel,thatid=document.getElementById(that_id);return window.getSelection?(sel=window.getSelection(),{text:trimcode(thatid.value.substring(thatid.selectionStart,thatid.selectionEnd)),start:thatid.selectionStart,end:thatid.selectionEnd,thatid:thatid}):document.selection?{text:trimcode(document.selection.createRange().text),start:0,end:0,thatid:thatid}:null}function encodeHtmlEntity(str){return str.replace(/[\u00A0-\u9999<>\&]/gim,(function(c){return"&#"+c.charCodeAt(0)+";"}))}function decodeHtmlEntity(str){var map={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return str.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,(function(m){return map[m]}))}function modelLoad(type){var html,liHTML="";$.get(default_url+"/themes/"+type+"-template.tpl",(function(data){$(html=data).appendTo("body").fadeIn(300),$.ajax({type:"POST",dataType:"json",url:"/bbcode.jquery.php",data:{action:type},success:function(data){switch(type){case"file":"ok"==data.status&&$.each(data.result,(function(index,element){liHTML+='<li><a href="#" data-rule="'+type+'" rel="'+UPLOAD_LOC+element.file_path+'"><span class="modal-display-name">'+element.name+'</span><br/><span class="modal-file-name">'+element.date_time+"</span></a></li>"})),$("#bb-file-list").html(liHTML);break;case"image":"ok"==data.status&&($.each(data.result,(function(index,element){liHTML+='<img data-rule="'+type+'" rel="'+UPLOAD_LOC+element.file_path+'" src="/content/uploads/'+element.file_path+'" alt="'+element.name+'">'})),$(".bb-modal-imagelist").html(liHTML))}}})}))}$.each(settings,(function(key,value){setTimeout((function(){value&&$.get(default_url+"/toolbar-"+key+".tpl").done((function(data){$(".bbcode-toolbar").append(data)}))}),250)})),$(document).on("keyup",".bb-bounding-styles",(function(){if(content!=$(this).html()){var replace_html=$(this).html();content=replace_html,$("."+that_class).text(replace_html)}})),$(document).on("mouseup keyup touchend","#content",(function(){divSelection=getSelectionRange()})),$(document).on("click",".bb-button-icon",(function(){var item=$(this).attr("aria-label").toLowerCase();switch(item){case"center":case"left":case"right":case"bold":case"italic":case"underline":case"strike":case"sub":case"sup":wrapBBCode(item);break;case"image":case"file":case"link":case"video":case"table-panel":case"list-panel":modelLoad(item)}})),$(document).on("click",".bb-dropdown span, .bb-dropdown a",(function(){var item=$(this).attr("data-rule"),rel=$(this).attr("rel");switch(item){case"color":case"highlight":case"font":case"size":wrapBBCode(item,rel);break;case"special":insertBBCode(item,rel)}})),$(document).on("click",".bb-modal-tabs a",(function(){var that=$(this);that.parent().find("a").each((function(index,element){$(this).removeClass("active")})),that.toggleClass("active");var item=that.attr("rel");$("[data-model-toggle]").hide(),$('[data-model-toggle*="'+item+'"]').toggle()})),$(document).on("click",".bb-close",(function(){$("#bb-overlay,#bb-modal").fadeOut(300,(function(){$(this).remove()}))})),$(document).on("click","#bb-modal",(function(e){e.target===this&&$(".bb-close").click()})),$(document).on("click",".btnColour",(function(){$(this).addClass("active"),$(".re-dropdown-box-textcolor").show(),$(".btnHighlight").removeClass("active"),$(".re-dropdown-box-backcolor").hide()})),$(document).on("click",".btnHighlight",(function(){$(this).addClass("active"),$(".re-dropdown-box-backcolor").show(),$(".btnColour").removeClass("active"),$(".re-dropdown-box-textcolor").hide()})),$(document).on("click",'img[data-rule="image"]',(function(){var item,rel;wrapBBCode($(this).attr("data-rule"),$(this).attr("rel")),$(".bb-close").click()})),$(document).on("click",'button[data-rule="link"]',(function(){var item=$(this).attr("data-rule"),url=$("#link-url").val(),text=$("#link-text").val(),isChecked=!1;$("#link-tab").is(":checked")&&(isChecked=!0),url.length>0&&validateURL(url)?(wrapBBCode(item,url,text,isChecked),$(".bb-close").click()):$(".link-error").css({display:"block"})})),$(document).on("click",'button[data-rule="youtube"]',(function(){var item=$(this).attr("data-rule"),url=$("#modal-video-input").val();url.length>0&&ytVidId(url)?(wrapBBCode(item,url),$(".bb-close").click()):$(".link-error").css({display:"block"})})),$(document).on("click",'button[data-rule="table-panel"]',(function(){var rows=$("#cmbRows").val(),columns=$("#cmbColumns").val();$(".bb-close").click(),$.get(default_url+"/table-template.tpl",(function(data){html=data,$(html).appendTo("body").fadeIn(300),makeTable($("#tableobj"),rows,columns)}))})),$(document).on("click",'button[data-rule="table"]',(function(){var rows=$("#bbcode_table").attr("data-rows"),ins="[table="+rows+"]",t=1;if($("#bbcode_table td textarea").each((function(){ins+=t<rows?$(this).val()+"[c]":$(this).val(),t++})),ins+="[/table]",focusOn(),window.getSelection)divSelection.thatid.value=divSelection.thatid.value.substring(0,divSelection.start)+ins+divSelection.thatid.value.substring(divSelection.start,divSelection.thatid.value.length),divSelection.thatid.setSelectionRange(divSelection.end+ins.length,divSelection.end+ins.length);else if(document.selection){var selectedRange=document.selection.createRange();selectedRange.moveStart("character",-divSelection.thatid.value.length),sel.text=ins,sel.moveStart("character",selectedRange.text.length+ins.length-divSelection.thatid.length)}divSelection=getSelectionRange(),$(".bb-close").click()})),$(document).on("click",'button[data-rule="list"]',(function(){var style,ins="[list="+$("#bbcode_list").attr("data-style")+"]";if($("#bbcode_list li textarea").each((function(){ins+="[*]"+$(this).val()})),ins+="[/list]",focusOn(),window.getSelection)divSelection.thatid.value=divSelection.thatid.value.substring(0,divSelection.start)+ins+divSelection.thatid.value.substring(divSelection.start,divSelection.thatid.value.length),divSelection.thatid.setSelectionRange(divSelection.end+ins.length,divSelection.end+ins.length);else if(document.selection){var selectedRange=document.selection.createRange();selectedRange.moveStart("character",-divSelection.thatid.value.length),sel.text=ins,sel.moveStart("character",selectedRange.text.length+ins.length-divSelection.thatid.length)}divSelection=getSelectionRange(),$(".bb-close").click()})),$(document).on("click",'button[data-rule="list-panel"]',(function(){var rows=$("#cmbRows").val();$(".bb-close").click(),$.get(default_url+"/themes/list-template.tpl",(function(data){html=data,$(html).appendTo("body").fadeIn(300),makeList($("#listobj"),$("#bbcode_list_option").val(),rows)}))})),$(document).on("click",'a[data-rule="file"]',(function(){var item,rel,inner;wrapBBCode($(this).attr("data-rule"),$(this).attr("rel"),$(this).find(".modal-display-name").html()),$(".bb-close").click()})),$(document).on("click",'button[data-command="cancel"]',(function(){$(".bb-close").click()})),$(document).on("keypress","#link-url",(function(event){$(this).val().length>-1&&$(".link-error").hide()}));var obj=$(".bb-drag-box,.bb-upload-label");function sendFileToServer(formData,status){formData.append("type",$(".bb-modal-type").attr("data-type")),formData.append("title",$("#file-title").val()?$("#file-title").val():"null");var jqXHR=$.ajax({xhr:function(){var xhrobj=$.ajaxSettings.xhr();return xhrobj.upload&&xhrobj.upload.addEventListener("progress",(function(event){var percent=0,position=event.loaded||event.position,total=event.total;event.lengthComputable&&(percent=Math.ceil(position/total*100)),status.setProgress(percent)}),!1),xhrobj},url:"/libs/bbcode.jquery.php",type:"POST",contentType:!1,dataType:"json",processData:!1,cache:!1,data:formData,success:function(data){"ok"==data.status&&(status.setProgress(100),wrapBBCode($(".bb-modal-type").attr("data-type"),data.result,$("#file-title").val()?$("#file-title").val():null),$(".bb-close").click())}});status.setAbort(jqXHR)}function createStatusbar(obj){var row="odd";++rowCount%2==0&&(row="even"),this.statusbar=$("<div class='statusbar "+row+"'></div>"),this.filename=$("<div class='filename'></div>").appendTo(this.statusbar),this.size=$("<div class='filesize'></div>").appendTo(this.statusbar),this.progressBar=$("<div class='progressBar'><div></div></div>").appendTo(this.statusbar),this.abort=$("<div class='abort'>Abort</div>").appendTo(this.statusbar),obj.after(this.statusbar),this.setFileNameSize=function(name,size){var sizeStr="",sizeKB=size/1024,sizeMB;parseInt(sizeKB)>1024?sizeStr=(sizeKB/1024).toFixed(2)+" MB":sizeStr=sizeKB.toFixed(2)+" KB";this.filename.html(name),this.size.html(sizeStr)},this.setProgress=function(progress){var progressBarWidth=progress*this.progressBar.width()/100;this.progressBar.find("div").animate({width:progressBarWidth},10).html(progress+"% "),parseInt(progress)>=100&&this.abort.hide()},this.setAbort=function(jqxhr){var sb=this.statusbar;this.abort.click((function(){jqxhr.abort(),sb.hide()}))}}function handleFileUpload(files,obj){for(var i=0;i<files.length;i++){var fd=new FormData;fd.append("file",files[i]);var status=new createStatusbar(obj);status.setFileNameSize(files[i].name,files[i].size),sendFileToServer(fd,status)}}$(document).on("dragenter",obj,(function(e){e.stopPropagation(),e.preventDefault(),$(this).css("border","2px dotted #0B85A1")})),$(document).on("dragover",obj,(function(e){e.stopPropagation(),e.preventDefault()})),$(document).on("drop",obj,(function(e){var files;$(this).css("border","2px dotted #0B85A1"),e.preventDefault(),handleFileUpload(e.originalEvent.dataTransfer.files,obj)})),$(document).on("dragenter",(function(e){e.stopPropagation(),e.preventDefault()})),$(document).on("dragover",(function(e){e.stopPropagation(),e.preventDefault()})),$(document).on("drop",(function(e){e.stopPropagation(),e.preventDefault()}))}}(jQuery);